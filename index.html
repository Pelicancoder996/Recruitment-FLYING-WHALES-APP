<script>
async function exportPDF() {
  console.log("üëâ Export PDF lanc√©");

  try {
    const jsPDFLib = window.jspdf || window.jsPDF;
    const jsPDF = jsPDFLib.jsPDF || jsPDFLib;

    if (!jsPDF) {
      alert("‚ö†Ô∏è jsPDF n‚Äôest pas charg√© correctement !");
      return;
    }

    const doc = new jsPDF({ unit: "mm", format: "a4" });
    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);

    // =============================
    // üé® HEADER
    // =============================
    doc.setFillColor(0, 51, 102);
    doc.rect(0, 0, 210, 30, "F");

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.setTextColor(255, 255, 255);
    doc.text("Rapport Salaire - Flying Whales", 15, 18);

    // =============================
    // üßæ INFOS PRINCIPALES
    // =============================
    const schoolSelect = document.getElementById("school");
    const school = schoolSelect?.options[schoolSelect.selectedIndex]?.text || "‚Äî";

    const jobSelect = document.getElementById("fonction");
    const job = jobSelect?.options[jobSelect.selectedIndex]?.text || "‚Äî";

    const classificationSelect = document.getElementById("classification");
    const classification = classificationSelect?.options[classificationSelect.selectedIndex]?.text || "‚Äî";

    const experience = (document.getElementById("experience").value || "0") + " ans";

    const subdomainSelect = document.getElementById("subdomain");
    const subdomain = subdomainSelect?.options[subdomainSelect.selectedIndex]?.text || "‚Äî";

    const sourceVal = document.getElementById("source").value;
    const median = document.getElementById("median").innerText || "N/A";
    const range = document.getElementById("range").innerText || "N/A";
    const insightText = document.getElementById("insightText")?.innerText || "";

    let sourceClean = "March√©";
    if (sourceVal === "fw") sourceClean = "Flying Whales (interne)";
    if (sourceVal === "croisee") sourceClean = "Donn√©es crois√©es";

    // ‚úÖ Sous-titre du header
    doc.setFontSize(10);
    doc.setTextColor(220, 230, 240);
    doc.text(`${job} | ${school} | ${classification} | ${experience} | ${subdomain}`, 15, 27);

    // =============================
    // üìä TABLEAU R√©f√©rence √âcole
    // =============================
    let y = 45;
    doc.setFont("helvetica", "bold");
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(13);
    doc.text("R√©f√©rence √©cole :", 15, y);

    // Calcul des P25, P50, P75 dynamiques
    let p25 = "N/A", p50 = "N/A", p75 = "N/A";
    if (schoolSelect?.selectedIndex >= 0) {
      const dataset = [
        ...schoolsIngenieur,
        ...schoolsCommerce,
        ...schoolsScPo,
        ...schoolsUniversite,
        ...schoolsIT,
        ...schoolsDesign
      ];
      const data = dataset.find(e => e.Ecole === school);
      if (data) {
        p25 = (data.p25 || 0).toLocaleString() + " ‚Ç¨";
        p50 = (data.p50 || 0).toLocaleString() + " ‚Ç¨";
        p75 = (data.p75 || 0).toLocaleString() + " ‚Ç¨";
      }
    }

    // Table header
    y += 8;
    doc.setFillColor(230, 236, 245);
    doc.rect(15, y, 180, 10, "F");
    doc.setFontSize(11);
    doc.text("√âcole", 22, y + 7);
    doc.text("P25 (‚Ç¨)", 100, y + 7);
    doc.text("M√©dian (‚Ç¨)", 135, y + 7);
    doc.text("P75 (‚Ç¨)", 170, y + 7);

    // Table row
    y += 12;
    doc.setFillColor(255, 255, 255);
    doc.rect(15, y, 180, 10, "F");
    doc.setFont("helvetica", "normal");
    doc.text(school, 22, y + 7);
    doc.text(p25, 108, y + 7, { align: "right" });
    doc.text(p50, 145, y + 7, { align: "right" });
    doc.text(p75, 180, y + 7, { align: "right" });

    // =============================
    // üìå KPI CARDS
    // =============================
    y += 25;
    const cardHeight = 25;

    // M√©dian
    doc.setFillColor(46, 204, 113);
    doc.roundedRect(15, y, 58, cardHeight, 3, 3, "F");
    doc.setFont("helvetica", "bold");
    doc.setTextColor(255, 255, 255);
    doc.text("M√©dian", 20, y + 10);
    doc.text(median, 20, y + 20);

    // Fourchette
    doc.setFillColor(52, 152, 219);
    doc.roundedRect(78, y, 68, cardHeight, 3, 3, "F");
    doc.text("Fourchette", 83, y + 10);
    doc.text(range, 83, y + 20);

    // Source
    doc.setFillColor(255, 165, 100);
    doc.roundedRect(152, y, 43, cardHeight, 3, 3, "F");
    doc.text("Source", 157, y + 10);
    doc.text(sourceClean, 157, y + 20);

    // =============================
    // üìà GRAPH
    // =============================
    y += 45;
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text("Projection salariale sur 40 ans", 15, y);

    const chartCanvas = document.getElementById("salaryChart");
    if (chartCanvas) {
      const imgData = chartCanvas.toDataURL("image/png", 1.0);
      doc.addImage(imgData, "PNG", 15, y + 5, 180, 80);
      y += 95;
    }

    // =============================
    // üí¨ ANALYSE PERSONNALIS√âE
    // =============================
    const insightBox = document.getElementById("insightBox");
    const bgColor = window.getComputedStyle(insightBox).backgroundColor;
    const rgb = bgColor.match(/\d+/g)?.map(Number) || [235, 245, 235];

    // Nettoyage des emojis
    const safeInsightText = insightText
      .replace(/üí°/g, "Analyse :")
      .replace(/üî∑/g, "Donn√©es FW :")
      .replace(/üåç/g, "Donn√©es march√© :")
      .replace(/‚öñÔ∏è/g, "Donn√©es crois√©es :")
      .replace(/üí¨/g, "Commentaire :");

    const wrappedInsight = doc.splitTextToSize(safeInsightText, 170);
    const blockHeight = Math.max(30, wrappedInsight.length * 6 + 15);

    y += 10;
    doc.setFillColor(...rgb);
    doc.roundedRect(15, y, 180, blockHeight, 3, 3, "F");

    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text("Analyse personnalis√©e :", 20, y + 10);

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text(wrappedInsight, 20, y + 20);
    y += blockHeight + 10;

    // =============================
    // üßæ R√âCAP
    // =============================
    doc.setFontSize(10);
    doc.setFont("helvetica", "italic");
    doc.setTextColor(80, 80, 80);

    const recap = `Profil ${job}, dipl√¥m√© de ${school}, ${classification}, ${experience}. Salaire m√©dian estim√© : ${median}. Projection sur 40 ans.`;
    doc.text(doc.splitTextToSize(recap, 180), 15, y);

    // =============================
    // üìå FOOTER
    // =============================
    doc.setFontSize(9);
    doc.setFont("helvetica", "italic");
    doc.setTextColor(120);

    let disclaimer = "Estimation indicative bas√©e sur le simulateur Flying Whales.";
    if (sourceVal === "marche") disclaimer = "Estimation bas√©e sur les donn√©es march√©.";
    else if (sourceVal === "fw") disclaimer = "Estimation bas√©e sur les packages internes Flying Whales.";
    else if (sourceVal === "croisee") disclaimer = "Estimation issue d'une combinaison march√© (40%) et FW (60%).";

    doc.text(disclaimer, 15, 280);
    const dateStr = new Date().toLocaleDateString("fr-FR");
    doc.text("Export√© le " + dateStr, 195, 280, { align: "right" });

    // =============================
    // üíæ SAVE
    // =============================
    doc.save("simulateur_salaire.pdf");
    console.log("‚úÖ PDF g√©n√©r√© et t√©l√©charg√©");
  } catch (err) {
    console.error("‚ùå Erreur export PDF :", err);
    alert("Erreur lors de l'export PDF !");
  }
}
</script>
